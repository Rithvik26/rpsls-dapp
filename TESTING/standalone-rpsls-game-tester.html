<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPSLS Game Tester (No MetaMask)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .players {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .player-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .player-card h2 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .address {
            font-family: monospace;
            font-size: 0.85em;
            color: #666;
            margin: 10px 0;
            word-break: break-all;
        }
        .balance {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
        }
        select, input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { background: #5568d3; transform: translateY(-2px); }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .game-status {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .game-status h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .log {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-info { color: #2196F3; }
        .secret-info {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .secret-info strong { color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Rock Paper Scissors Lizard Spock Tester</h1>
        
        <div class="game-status">
            <h2>ğŸ¯ Game Status</h2>
            <div id="gameInfo">Not started</div>
            <div class="log" id="logArea"></div>
        </div>

        <div class="players">
            <!-- Player 1 -->
            <div class="player-card">
                <h2>ğŸ­ Player 1 (Creator)</h2>
                <div class="address" id="p1Address">Loading...</div>
                <div class="balance" id="p1Balance">Balance: Loading...</div>
                
                <h3 style="margin-top: 20px;">Create Game</h3>
                <select id="p1Move">
                    <option value="1">ğŸª¨ Rock</option>
                    <option value="2">ğŸ“„ Paper</option>
                    <option value="3">âœ‚ï¸ Scissors</option>
                    <option value="4">ğŸ–– Spock</option>
                    <option value="5">ğŸ¦ Lizard</option>
                </select>
                <input type="text" id="stake" value="0.0001" placeholder="Stake (ETH)">
                <button onclick="createGame()" id="createBtn">ğŸ® Create Game</button>
                
                <div class="secret-info" id="p1Secret" style="display:none;">
                    <strong>ğŸ”’ Your Secret (Save This!):</strong><br>
                    Move: <span id="secretMove"></span><br>
                    Salt: <span id="secretSalt" style="font-family: monospace; font-size: 0.8em; word-break: break-all;"></span>
                </div>
                
                <h3 style="margin-top: 20px;">Reveal Move</h3>
                <button onclick="revealMove()" id="revealBtn" disabled>ğŸ”“ Reveal Move</button>
            </div>

            <!-- Player 2 -->
            <div class="player-card">
                <h2>ğŸ² Player 2 (Opponent)</h2>
                <div class="address" id="p2Address">Loading...</div>
                <div class="balance" id="p2Balance">Balance: Loading...</div>
                
                <h3 style="margin-top: 20px;">Join Game</h3>
                <input type="text" id="contractAddr" placeholder="Contract Address" readonly>
                <select id="p2Move">
                    <option value="1">ğŸª¨ Rock</option>
                    <option value="2">ğŸ“„ Paper</option>
                    <option value="3">âœ‚ï¸ Scissors</option>
                    <option value="4">ğŸ–– Spock</option>
                    <option value="5">ğŸ¦ Lizard</option>
                </select>
                <button onclick="joinGame()" id="joinBtn" disabled>ğŸ¯ Join & Play Move</button>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ABI = [
            {
                "constant": true,
                "inputs": [],
                "name": "c1Hash",
                "outputs": [{ "name": "", "type": "bytes32" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "c2",
                "outputs": [{ "name": "", "type": "uint8" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "j1",
                "outputs": [{ "name": "", "type": "address" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "j2",
                "outputs": [{ "name": "", "type": "address" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [],
                "name": "j1Timeout",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [],
                "name": "j2Timeout",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "lastAction",
                "outputs": [{ "name": "", "type": "uint256" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [{ "name": "_c2", "type": "uint8" }],
                "name": "play",
                "outputs": [],
                "payable": true,
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    { "name": "_c1", "type": "uint8" },
                    { "name": "_salt", "type": "uint256" }
                ],
                "name": "solve",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "stake",
                "outputs": [{ "name": "", "type": "uint256" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "TIMEOUT",
                "outputs": [{ "name": "", "type": "uint256" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    { "name": "_c1", "type": "uint8" },
                    { "name": "_c2", "type": "uint8" }
                ],
                "name": "win",
                "outputs": [{ "name": "w", "type": "bool" }],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "name": "_c1Hash", "type": "bytes32" },
                    { "name": "_j2", "type": "address" }
                ],
                "payable": true,
                "stateMutability": "payable",
                "type": "constructor"
            }
        ];

        const CONTRACT_BYTECODE = "0x608060405261012c600555604051604080610aaf833981018060405281019080805190602001909291908051906020019092919050505034600481905550336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600281600019169055504260068190555050506109ce806100e16000396000f3006080604052600436106100ba576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630c4395b9146100bf578063294914a4146101145780633a4b66f11461012b57806348e257cb146101565780634d03e3d21461018f57806353a04b05146101c257806380985af9146101e557806389f71d531461023c578063a5ddec7c14610267578063c37597c6146102a1578063c8391142146102f8578063f56f48f21461030f575b600080fd5b3480156100cb57600080fd5b506100fa600480360381019080803560ff169060200190929190803560ff16906020019092919050505061033a565b604051808215151515815260200191505060405180910390f35b34801561012057600080fd5b50610129610403565b005b34801561013757600080fd5b506101406104ae565b6040518082815260200191505060405180910390f35b34801561016257600080fd5b5061016b6104b4565b6040518082600581111561017b57fe5b60ff16815260200191505060405180910390f35b34801561019b57600080fd5b506101a46104c7565b60405180826000191660001916815260200191505060405180910390f35b6101e3600480360381019080803560ff1690602001909291905050506104cd565b005b3480156101f157600080fd5b506101fa6105c0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561024857600080fd5b506102516105e6565b6040518082815260200191505060405180910390f35b34801561027357600080fd5b5061029f600480360381019080803560ff169060200190929190803590602001909291905050506105ec565b005b3480156102ad57600080fd5b506102b66108c7565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561030457600080fd5b5061030d6108ec565b005b34801561031b57600080fd5b5061032461099c565b6040518082815260200191505060405180910390f35b600081600581111561034857fe5b83600581111561035457fe5b141561036357600090506103fd565b6000600581111561037057fe5b83600581111561037c57fe5b141561038b57600090506103fd565b600282600581111561039957fe5b8115156103a257fe5b0660028460058111156103b157fe5b8115156103ba57fe5b0614156103e1578160058111156103cd57fe5b8360058111156103d957fe5b1090506103fd565b8160058111156103ed57fe5b8360058111156103f957fe5b1190505b92915050565b6000600581111561041057fe5b600360009054906101000a900460ff16600581111561042b57fe5b14151561043757600080fd5b600554600654014211151561044b57600080fd5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6004549081150290604051600060405180830381858888f19350505050506000600481905550565b60045481565b600360009054906101000a900460ff1681565b60025481565b600060058111156104da57fe5b600360009054906101000a900460ff1660058111156104f557fe5b14151561050157600080fd5b6000600581111561050e57fe5b81600581111561051a57fe5b1415151561052757600080fd5b6004543414151561053757600080fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561059357600080fd5b80600360006101000a81548160ff021916908360058111156105b157fe5b02179055504260068190555050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60065481565b600060058111156105f957fe5b82600581111561060557fe5b1415151561061257600080fd5b6000600581111561061f57fe5b600360009054906101000a900460ff16600581111561063a57fe5b1415151561064757600080fd5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156106a257600080fd5b600254600019168282604051808360058111156106bb57fe5b60ff167f01000000000000000000000000000000000000000000000000000000000000000281526001018281526020019250505060405180910390206000191614151561070757600080fd5b61072082600360009054906101000a900460ff1661033a565b15610786576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6004546002029081150290604051600060405180830381858888f19350505050506108bb565b61079f600360009054906101000a900460ff168361033a565b1561080657600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6004546002029081150290604051600060405180830381858888f19350505050506108ba565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6004549081150290604051600060405180830381858888f1935050505050600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6004549081150290604051600060405180830381858888f19350505050505b5b60006004819055505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600060058111156108f957fe5b600360009054906101000a900460ff16600581111561091457fe5b1415151561092157600080fd5b600554600654014211151561093557600080fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6004546002029081150290604051600060405180830381858888f19350505050506000600481905550565b600554815600a165627a7a7230582018ed5688228204f232708cfefdc2b080164f682cc27144d1dd0e8c1b59c9c4470029"; 

        let provider, player1, player2, gameContract;
        let savedMove, savedSalt, savedCommitment;

        const MOVES = ['Null', 'Rock', 'Paper', 'Scissors', 'Spock', 'Lizard'];

        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function generateSalt() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return '0x' + Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function generateCommitment(move, salt) {
            const encoded = ethers.utils.solidityPack(['uint8', 'uint256'], [move, salt]);
            return ethers.utils.keccak256(encoded);
        }

        async function init() {
            try {
                // Connect to Ganache
                provider = new ethers.providers.JsonRpcProvider('http://127.0.0.1:8545');
                
                // Create wallets from Ganache private keys
                player1 = new ethers.Wallet(
                    '0x35a8f8c24804fd3ea1e0b9fdd46c6db5808338544b711a08cf56cab7b15d69dd',
                    provider
                );
                player2 = new ethers.Wallet(
                    '0x0440919564aa80c8cf0303a86ae9c7f90b4da1a883a31d3a87625ba2145e21e4',
                    provider
                );

                // Update UI
                document.getElementById('p1Address').textContent = player1.address;
                document.getElementById('p2Address').textContent = player2.address;

                await updateBalances();
                log('âœ… Connected to Ganache', 'success');
                log(`Player 1: ${player1.address}`, 'info');
                log(`Player 2: ${player2.address}`, 'info');
            } catch (error) {
                log('âŒ Failed to connect to Ganache: ' + error.message, 'error');
                log('Make sure Ganache is running on port 8545!', 'error');
            }
        }

        async function updateBalances() {
            const bal1 = await provider.getBalance(player1.address);
            const bal2 = await provider.getBalance(player2.address);
            document.getElementById('p1Balance').textContent = 
                `Balance: ${ethers.utils.formatEther(bal1)} ETH`;
            document.getElementById('p2Balance').textContent = 
                `Balance: ${ethers.utils.formatEther(bal2)} ETH`;
        }

        async function createGame() {
            try {
                document.getElementById('createBtn').disabled = true;
                log('ğŸ® Creating game...', 'info');

                const move = parseInt(document.getElementById('p1Move').value);
                const stakeEth = document.getElementById('stake').value;
                const stake = ethers.utils.parseEther(stakeEth);

                // Generate commitment
                savedSalt = generateSalt();
                savedMove = move;
                savedCommitment = generateCommitment(move, savedSalt);

                log(`ğŸ”’ Generated commitment for ${MOVES[move]}`, 'info');
                log(`Salt: ${savedSalt.substring(0, 20)}...`, 'info');

                // Manually encode constructor params
                const encodedHash = savedCommitment.slice(2).padStart(64, '0');
                const encodedAddress = player2.address.slice(2).toLowerCase().padStart(64, '0');
                const constructorParams = encodedHash + encodedAddress;
                
                // Combine bytecode
                const fullBytecode = CONTRACT_BYTECODE + constructorParams;

                // Deploy
                log('â³ Deploying contract...', 'info');
                const tx = await player1.sendTransaction({
                    data: fullBytecode,
                    value: stake,
                    gasLimit: 3000000
                });
                
                log('â³ Waiting for deployment...', 'info');
                const receipt = await tx.wait();
                
                const address = receipt.contractAddress;
                gameContract = new ethers.Contract(address, CONTRACT_ABI, player1);
                document.getElementById('contractAddr').value = address;
                
                log(`âœ… Game created at ${address}`, 'success');
                log(`Stake: ${stakeEth} ETH`, 'info');

                // Show secret
                document.getElementById('p1Secret').style.display = 'block';
                document.getElementById('secretMove').textContent = MOVES[move];
                document.getElementById('secretSalt').textContent = savedSalt;

                document.getElementById('joinBtn').disabled = false;
                await updateBalances();
            } catch (error) {
                log('âŒ Error creating game: ' + error.message, 'error');
                console.error(error);
                document.getElementById('createBtn').disabled = false;
            }
        }

        async function joinGame() {
            try {
                document.getElementById('joinBtn').disabled = true;
                log('ğŸ¯ Player 2 joining game...', 'info');

                const move = parseInt(document.getElementById('p2Move').value);
                const stakeEth = document.getElementById('stake').value;
                const stake = ethers.utils.parseEther(stakeEth);

                // Connect Player 2 to contract
                const gameAsPlayer2 = gameContract.connect(player2);
                
                log(`Player 2 playing: ${MOVES[move]}`, 'info');
                const tx = await gameAsPlayer2.play(move, { value: stake });
                
                log('â³ Waiting for transaction...', 'info');
                await tx.wait();
                
                log(`âœ… Player 2 joined with ${MOVES[move]}!`, 'success');
                document.getElementById('revealBtn').disabled = false;
                await updateBalances();
            } catch (error) {
                log('âŒ Error joining game: ' + error.message, 'error');
                document.getElementById('joinBtn').disabled = false;
            }
        }

        async function revealMove() {
            try {
                document.getElementById('revealBtn').disabled = true;
                log('ğŸ”“ Player 1 revealing move...', 'info');

                const tx = await gameContract.solve(savedMove, savedSalt);
                log('â³ Waiting for reveal...', 'info');
                await tx.wait();

                log('âœ… Move revealed!', 'success');
                log(`Player 1 played: ${MOVES[savedMove]}`, 'info');

                // Get Player 2's move
                const c2 = await gameContract.c2();
                log(`Player 2 played: ${MOVES[c2]}`, 'info');

                // Determine winner
                determineWinner(savedMove, c2);
                
                await updateBalances();
                
                // Reset for new game
                setTimeout(() => {
                    document.getElementById('createBtn').disabled = false;
                    document.getElementById('p1Secret').style.display = 'none';
                    log('ğŸ”„ Ready for new game!', 'success');
                }, 2000);
            } catch (error) {
                log('âŒ Error revealing: ' + error.message, 'error');
            }
        }

        function determineWinner(move1, move2) {
            if (move1 === move2) {
                log('ğŸ¤ It\'s a tie!', 'info');
                return;
            }

            const wins = {
                1: [3, 5], // Rock beats Scissors, Lizard
                2: [1, 4], // Paper beats Rock, Spock
                3: [2, 5], // Scissors beats Paper, Lizard
                4: [3, 1], // Spock beats Scissors, Rock
                5: [4, 2]  // Lizard beats Spock, Paper
            };

            if (wins[move1].includes(move2)) {
                log('ğŸ† Player 1 WINS!', 'success');
            } else {
                log('ğŸ† Player 2 WINS!', 'success');
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
